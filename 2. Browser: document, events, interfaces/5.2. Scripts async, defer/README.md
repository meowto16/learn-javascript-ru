# Скрипты: async, defer

Когда браузер загружает HTML и доходит до тега `<script>`, 
он не может продолжать строить DOM. Он должен сначала выполнить скрипт.

## defer

Означает, что нужно загружать скрипт в фоновом режиме, и продолжить обрабатывать
HTML-страницу. А затем нужно будет запустить этот скрипт, когда DOM-дерево будет готово.

- Скрипты с `defer` никогда не блокируют страницу.
- Скрипты с `defer` всегда выполняются, когда дерево `DOM` готово, 
  но до события `DOMContentLoaded`.
- Скрипты с `defer` сохраняют порядок относительно друг друга, как и обычные скрипты.
  - Маленький скрипт хоть и загрузится первым, но выполнится вторым (т.е просто по порядку)
- `defer` предназначен только для внешних скриптов. Внутрь тега нет смысла что-то помещать

## async

Означает, что скрипт абсолютно независим.

- Страница не ждет асинхронных скриптов, содержимое обрабатывается и отображается.
- Событие `DOMContentLoaded` и асинхронные скрипты не ждут друг друга.
- Остальные скрипты не ждут `async`
  - так что если у нас несколько скриптов с `async` - они не будут ждать друг друга. Они вообще не будут ничего ждать
  - То есть, скрипты выполняются в порядке загрузки.

## Динамически загружаемые скрипты

```js
let script = document.createElement('script');
script.src = "/article/script-async-defer/long.js";
document.body.append(script); // (*)
```

- Скрипт начнёт загружаться, как только он будет добавлен в документ
- Динамически загружаемые скрипты по умолчанию ведут себя как `async`

Мы можем изменить относительный порядок скриптов с «первый загрузился – первый выполнился» на порядок, в котором они идут в документе (как в обычных скриптах) с помощью явной установки свойства async в false:

```js
let script = document.createElement('script');
script.src = "/article/script-async-defer/long.js";

script.async = false;

document.body.append(script);
```

## Когда и что использовать

- `defer` используется для скриптов, которым требуется доступ ко всему `DOM` и/или важен их относительный порядок выполнения.
- `async` хорош для независимых скриптов, например счётчиков и рекламы, относительный порядок выполнения которых не играет роли.