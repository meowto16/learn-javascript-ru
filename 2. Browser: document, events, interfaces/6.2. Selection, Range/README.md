# Selection и Range

## Range

Range - используется для выделения текста (DOM-узлов).

```html
<p id="p">Example: <i>italic</i> and <b>bold</b></p>

<script>
  let range = new Range();

  range.setStart(p, 0);
  range.setEnd(p, 2);

  // toString, вызванный у экземпляра Range, возвращает его содержимое в виде текста (без тегов)
  alert(range); // Example: italic

  // применим этот диапазон к выделению документа (объясняется далее)
  document.getSelection().addRange(range);
</script>
```

### Свойства

- `startContainer`, `startOffset` – узел и начальное смещение,
  в примере выше: первый текстовый узел внутри тега `<p>` и 2.
- `endContainer`, `endOffset` – узел и конечное смещение,
  в примере выше: первый текстовый узел внутри тега `<b>` и 3.
- `collapsed` – `boolean`, `true`, если диапазон начинается и заканчивается на одном и том же месте 
  (следовательно, в диапазон ничего не входит), в примере выше: `false`
- `commonAncestorContainer` – ближайший общий предок всех узлов в пределах диапазона,
  в примере выше: <p>

### Методы Range

#### Установить начало диапазона:

- `setStart(node, offset)` установить начальную границу в позицию `offset` в `node`
- `setStartBefore(node)` установить начальную границу прямо перед `node`
- `setStartAfter(node)` установить начальную границу прямо после `node`

#### Установить конец диапазона (похожи на предыдущие методы):

- `setEnd(node, offset)` установить конечную границу в позицию `offset` в `node`
- `setEndBefore(node)` установить конечную границу прямо перед `node`
- `setEndAfter(node)` установить конечную границу прямо после `node`

> `node` может быть как текстовым узлом, так и элементом

#### Другие:

- `selectNode(node)` выделить node целиком
- `selectNodeContents(node)` выделить всё содержимое node
- `collapse(toStart)` если указано `toStart=true`, установить конечную границу в начало, иначе установить начальную границу в конец, 
  схлопывая таким образом диапазон
- `cloneRange()` создать новый диапазон с идентичными границами

#### Чтобы манипулировать содержимым в пределах диапазона:

- `deleteContents()` – удалить содержимое диапазона из документа
- `extractContents()` – удалить содержимое диапазона из документа и вернуть как `DocumentFragment`
- `cloneContents()` – склонировать содержимое диапазона и вернуть как `DocumentFragment`
- `insertNode(node)` – вставить `node` в документ в начале диапазона
- `surroundContents(node)` – обернуть node вокруг содержимого диапазона. Чтобы этот метод сработал, диапазон должен 
  содержать как открывающие, так и закрывающие теги для всех элементов внутри себя: не допускаются частичные диапазоны по типу `<i>abc`.

> Также существуют методы сравнения диапазонов, но они редко используются. Когда они вам 
  понадобятся, вы можете прочитать о них в спецификации или справочнике MDN.

## Selection

`Range` это общий объект для управления диапазонами выделения. 
Мы можем создавать и передавать подобные объекты. 
Сами по себе они ничего визуально не выделяют.

Выделение в документе представлено объектом `Selection`, 
который может быть получен как `window.getSelection()` или `document.getSelection()`.

### Свойства

#### Основные:
- `anchorNode` – узел, с которого начинается выделение,
- `anchorOffset` – смещение в `anchorNode`, где начинается выделение,
- `focusNode` – узел, на котором выделение заканчивается,
- `focusOffset` – смещение в `focusNode`, где выделение заканчивается,
- `isCollapsed` – `true`, если диапазон выделения пуст или не существует.
- `rangeCount` – количество диапазонов в выделении, максимум 1 во всех браузерах, кроме `Firefox`.

### Получить выделение

Чтобы получить всё выделение:

- Как текст: просто вызовите `document.getSelection().toString()`.
- Как DOM-элементы: получите выделенные диапазоны и вызовите их метод `cloneContents()` 
(только первый диапазон, если мы не поддерживаем мультивыделение в `Firefox`).

### Методы Selection

Методы Selection для добавления и удаления диапазонов:

- `getRangeAt(i)` – взять `i`-ый диапазон, начиная с 0. Во всех браузерах, кроме `Firefox`, используется только 0.
- `addRange(range)` – добавить range в выделение. Все браузеры, кроме `Firefox`, проигнорируют этот вызов, если в выделении уже есть диапазон.
- `removeRange(range)` – удалить range из выделения.
- `removeAllRanges()` – удалить все диапазоны.
- `empty()` – сокращение для `removeAllRanges`.

Также существуют методы управления диапазонами выделения напрямую, без обращения к `Range`:

- `collapse(node, offset)` – заменить выделенный диапазон новым, который начинается и заканчивается на `node`, на позиции `offset`.
- `setPosition(node, offset)` – то же самое, что `collapse` (дублирующий метод-псевдоним).
- `collapseToStart()` – схлопнуть (заменить на пустой диапазон) к началу выделения,
- `collapseToEnd()` – схлопнуть диапазон к концу выделения,
- `extend(node, offset)` – переместить фокус выделения к данному `node`, с позиции `offset`,
- `setBaseAndExtent(anchorNode, anchorOffset, focusNode, focusOffset)` – заменить диапазон выделения на заданные начало `anchorNode`/`anchorOffset` и конец `focusNode`/`focusOffset`. 
  Будет выделено всё содержимое между этими границами
- `selectAllChildren(node)` – выделить все дочерние узлы данного узла `node`.
- `deleteFromDocument()` – удалить содержимое выделения из документа.
- `containsNode(node, allowPartialContainment = false)` – проверяет, содержит ли выделение `node` (частично, если второй аргумент равен `true`)

> Чтобы что-то выделить, сначала снимите текущее выделение
> 
> Используйте `removeAllRanges()`

## Выделение в элементах форм

Элементы форм, такие как `input` и `textarea`, предоставляют отдельное API для выделения. 

### Свойства:

- `input.selectionStart` – позиция начала выделения (это свойство можно изменять),
- `input.selectionEnd` – позиция конца выделения (это свойство можно изменять),
- `input.selectionDirection` – направление выделения, одно из: «forward» (вперёд), «backward» (назад) или «none» 
(без направления, если, к примеру, выделено с помощью двойного клика мыши).

### События:

- `input.onselect` - срабатывает, когда выделение завершено.

### Методы:

- `input.select()` - выделяет всё содержимое `input` (может быть `textarea` вместо `input`)
- `input.setSelectionRange(start, end, [direction])` – изменить выделение, чтобы начиналось 
  с позиции `start`, и заканчивалось `end`, в данном направлении `direction` (необязательный параметр).
- `input.setRangeText(replacement, [start], [end], [selectionMode])` – заменяет выделенный текст в диапазоне новым.

### Пример: изменение позиции курсора

```html
<textarea id="area" style="width:80%;height:60px">
Переведите фокус на меня, курсор окажется на 10-й позиции
</textarea>

<script>
  area.onfocus = () => {
    // нулевая задержка setTimeout нужна, чтобы это сработало после получения фокуса элементом формы
    setTimeout(() => {
      // мы можем задать любое выделение
      // если начало и конец совпадают, курсор устанавливается на этом месте
      area.selectionStart = area.selectionEnd = 10;
    })
  };
</script>
```

## Сделать что-то невыделяемым

1. Используйте CSS-свойство `user-select: none`.
2. Предотвратить действие по умолчанию в событии `onselectstart` или `mousedown`.
3. Мы также можем очистить выделение после срабатывания с помощью `document.getSelection().empty()`. 
   Этот способ используется редко, так как он вызывает нежелаемое мерцание при появлении и исчезновении выделения.

На [learn.javascript.ru](https://learn.javascript.ru/selection-range#metody-selection) много полезных готовых решений.